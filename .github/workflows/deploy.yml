name: üöÄ Full WordPress Deploy to cPanel (Files + Database)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup SSH access
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.CPANEL_HOST }} >> ~/.ssh/known_hosts

      # 3Ô∏è‚É£ Deploy all WordPress files to cPanel
      - name: Upload all files via SSH (rsync)
        run: |
          rsync -avz --delete \
            --exclude ".git*" \
            --exclude ".github" \
            --exclude "node_modules" \
            ./ ${{ secrets.SSH_USER }}@${{ secrets.CPANEL_HOST }}:/home/${{ secrets.CPANEL_USER }}/public_html/chuna.docapply4mefilebin.com/

      # 4Ô∏è‚É£ Upload database dump if exists
      - name: Upload database dump
        if: hashFiles('db.sql') != ''
        run: |
          scp db.sql ${{ secrets.SSH_USER }}@${{ secrets.CPANEL_HOST }}:/home/${{ secrets.CPANEL_USER }}/db.sql

      # 5Ô∏è‚É£ Import the database into cPanel MySQL
      - name: Import database on server
        if: hashFiles('db.sql') != ''
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.CPANEL_HOST }} "
            mysql -u${{ secrets.DB_USER }} -p'${{ secrets.DB_PASSWORD }}' ${{ secrets.DB_NAME }} < /home/${{ secrets.CPANEL_USER }}/db.sql &&
            rm /home/${{ secrets.CPANEL_USER }}/db.sql
          "
